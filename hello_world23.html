<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>위도 경도로 주소 변환</title>
    <style>
        #result pre {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

<div>
    <input type="checkbox" id="prettyPrint" checked>
    <label for="prettyPrint">Pretty Print</label>
</div>

<div id="result"></div>

<script type="text/javascript">
    function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    function returnJsonToClient(jsonData) {
        const checkbox = document.getElementById('prettyPrint');
        const preElement = document.createElement('pre');
        
        // 체크박스 상태에 따라 포맷 적용
        if (checkbox.checked) {
            preElement.textContent = JSON.stringify(jsonData, null, 4);
        } else {
            preElement.textContent = JSON.stringify(jsonData);
        }
        
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = ''; // 기존 내용을 지우고 새로 추가
        resultDiv.appendChild(preElement);
    }

    // 체크박스 변경 이벤트 처리
    document.getElementById('prettyPrint').addEventListener('change', function() {
        // 여기서는 테스트용 예제 JSON 데이터를 사용
        const testJson = {
            complexList: [{
                lat: 35.143164,
                lon: 128.97344,
                roadAddr: "부산광역시",
                jibunAddr: "부산광역시 남구"
            }]
        };
        returnJsonToClient(testJson);
    });

    function onLoadNaverMaps() {
        var latitude = parseFloat(getQueryParam('lat'));
        var longitude = parseFloat(getQueryParam('lng'));

        if (!isNaN(latitude) && !isNaN(longitude)) {
            waitForNaverMapsAPI(latitude, longitude);
        } else {
            console.error('Invalid latitude or longitude:', latitude, longitude);
            alert('Invalid latitude or longitude!');
        }
    }

    function waitForNaverMapsAPI(lat, lng) {
        if (typeof naver !== 'undefined' && typeof naver.maps !== 'undefined' && typeof naver.maps.Service !== 'undefined') {
            getAddressByCoordinates(lat, lng);
        } else {
            console.log('Waiting for Naver Maps API to load...');
            setTimeout(function() {
                waitForNaverMapsAPI(lat, lng);
            }, 100);
        }
    }

    function getAddressByCoordinates(lat, lng) {
        console.log('Getting address for coordinates:', lat, lng);

        naver.maps.Service.reverseGeocode({
            location: new naver.maps.LatLng(lat, lng),
        }, function(status, response) {
            if (status !== naver.maps.Service.Status.OK) {
                console.error('Geocoding error:', status, response);
                return alert('Something wrong! Status: ' + status);
            }

            var result = response.result,
                items = result.items;

            if (items.length === 0) {
                console.warn('No address found for coordinates:', lat, lng);
                return alert('No address found!');
            }

            var addressInfo = {
                complexList: [{
                    lat: lat,
                    lon: lng,
                    roadAddr: items[1] ? items[1].address : '없음',
                    jibunAddr: items[0].address
                }]
            };

            returnJsonToClient(addressInfo);
        });
    }

    function initialize() {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=y9n3b00wzy&submodules=geocoder';
        script.async = true;
        script.onload = function() {
            console.log('Naver Maps API loaded.');
            onLoadNaverMaps();
        };
        document.head.appendChild(script);
    }

    window.onload = initialize;
</script>
</body>
</html>
